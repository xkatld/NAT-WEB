{% extends 'layout.html' %}

{% block content %}

{# 添加规则表单 #}
<div class="card mb-4">
    <div class="card-header">
        添加端口转发规则 (DNAT on {{ public_interface }})
    </div>
    <div class="card-body">
        <form method="POST" class="row g-3 align-items-end">
            {{ dnat_form.csrf_token }}

            <div class="col-md-auto">
                {{ dnat_form.protocol.label(class_="form-label") }}
                {{ dnat_form.protocol(class_="form-select") }}
                {% for error in dnat_form.protocol.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.public_port.label(class_="form-label") }}
                {{ dnat_form.public_port(class_="form-control", type="number", min="1", max="65535", placeholder="主机端口") }}
                {% for error in dnat_form.public_port.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto d-flex align-items-center mb-3">
                 <span class="fw-bold fs-5">→ 内网</span> {# Arrow and bold text #}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.internal_ip.label(class_="form-label") }}
                {{ dnat_form.internal_ip(class_="form-control", placeholder="内网 IP") }}
                 {% for error in dnat_form.internal_ip.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.container_port.label(class_="form-label") }}
                {{ dnat_form.container_port(class_="form-control", type="number", min="1", max="65535", placeholder="容器端口") }}
                 {% for error in dnat_form.container_port.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.submit(class_="btn btn-primary", name="add_dnat_submit") }} {# Use unique button name #}
            </div>
        </form>
    </div>
</div>

{# MASQUERADE 管理 #}
<div class="card mb-4">
    <div class="card-header">
        管理 MASQUERADE 规则 (内网通过 {{ public_interface }} 访问外网)
    </div>
    <div class="card-body">
         <p class="card-text text-muted">确保内网设备可以通过 {{ public_interface }} 接口进行源地址转换 (NAT)，以访问互联网。</p>
        <form method="POST" class="row g-3 align-items-center">
            {{ masq_form.csrf_token }}
             <div class="col-md-auto">
                {{ masq_form.submit(class_="btn btn-success", name="masq_submit") }} {# Use unique button name #}
             </div>
             <div class="col-md-auto">
                 <span class="text-muted">点击添加标准 MASQUERADE 规则（通常只需要一条）。</span>
             </div>
        </form>
    </div>
</div>


{# 规则列表 #}
<h2 class="mb-3">当前 NAT PREROUTING 规则 (来自 iptables)</h2>

<form action="{{ url_for('clear_all_prerouting') }}" method="post" onsubmit="return confirm('您确定要清空 NAT PREROUTING 链的所有规则吗？此操作不可逆！');" class="mb-3">
    <button type="submit" class="btn btn-danger">清空所有 PREROUTING 规则</button>
    <p class="text-muted mt-2">警告：这将强制删除 iptables NAT 表 PREROUTING 链的所有规则，包括非本应用添加的！</p>
</form>


{% if rules %}
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover caption-top">
         <caption>当前的 PREROUTING 转发规则 (仅 DNAT)</caption>
        <thead class="table-light">
            <tr>
                <th>行号</th>
                <th>协议</th>
                <th>入站接口</th>
                <th>目标端口</th>
                <th> -> </th> {# Arrow column #}
                <th>目标地址:端口</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in rules %}
            <tr>
                <td>{{ rule.line_number }}</td>
                <td>{{ rule.protocol }}</td>
                <td>{{ rule.in_interface }}</td>
                <td>{{ rule.dport }}</td>
                <td>→</td>
                <td>{{ rule.to_destination }}</td>
                <td>
                    <form action="{{ url_for('index') }}" method="post" style="display:inline;"> {# Submit back to index #}
                        {{ dnat_form.csrf_token }} {# Need CSRF token for POST #}
                        <input type="hidden" name="line_number" value="{{ rule.line_number }}">
                        <button type="submit" class="btn btn-danger btn-sm" name="delete_rule_submit" onclick="return confirm('您确定要删除行号为 {{ rule.line_number }} 的规则吗？');">删除</button> {# Unique button name for delete #}
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="text-muted">注意：此列表仅显示 PREROUTING 链中匹配本应用添加格式的 DNAT 规则。</p>
{% else %}
<div class="alert alert-info" role="alert">
    NAT PREROUTING 链当前没有匹配格式的转发规则。
</div>
{% endif %}


{% endblock %}
