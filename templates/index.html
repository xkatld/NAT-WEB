{% extends 'layout.html' %}

{% block content %}

<p class="alert alert-info">
    注意：此页面管理的 NAT 规则直接操作当前系统的 iptables，规则**不会持久化**到文件或数据库。主机重启后规则会丢失，且需要此 Web 应用以足够权限(如 root 或 sudo)运行。
</p>

{# 添加规则表单 #}
<div class="card mb-4">
    <div class="card-header">
        添加端口转发规则 (DNAT on {{ public_interface }})
    </div>
    <div class="card-body">
        <form method="POST" class="row g-3 align-items-end">
            {{ dnat_form.csrf_token }}
            {{ dnat_form.form_id }} {# 渲染隐藏字段 #}

            <div class="col-md-auto">
                {{ dnat_form.protocol.label(class_="form-label") }}
                {{ dnat_form.protocol(class_="form-select") }}
                {% for error in dnat_form.protocol.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.public_port.label(class_="form-label") }}
                {{ dnat_form.public_port(class_="form-control", type="number", min="1", max="65535", placeholder="主机端口") }}
                {% for error in dnat_form.public_port.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto d-flex align-items-center mb-3">
                 <span class="fw-bold fs-5">→ 内网</span>
            </div>

            <div class="col-md-auto">
                {{ dnat_form.internal_ip.label(class_="form-label") }}
                {{ dnat_form.internal_ip(class_="form-control", placeholder="内网 IP") }}
                 {% for error in dnat_form.internal_ip.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.container_port.label(class_="form-label") }}
                {{ dnat_form.container_port(class_="form-control", type="number", min="1", max="65535", placeholder="容器端口") }}
                 {% for error in dnat_form.container_port.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.submit(class_="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>

{# MASQUERADE 管理 #}
<div class="card mb-4">
    <div class="card-header">
        管理 MASQUERADE 规则 (内网通过 {{ public_interface }} 访问外网)
    </div>
    <div class="card-body">
         <p class="card-text text-muted">确保内网设备可以通过 {{ public_interface }} 接口进行源地址转换 (NAT)，以访问互联网。</p>
        <form method="POST" class="row g-3 align-items-center">
            {{ masq_form.csrf_token }}
            {{ masq_form.form_id }} {# 渲染隐藏字段 #}
             <div class="col-md-auto">
                {{ masq_form.submit(class_="btn btn-success") }}
             </div>
             <div class="col-md-auto">
                 <span class="text-muted">点击添加标准 MASQUERADE 规则（通常只需要一条）。如果已存在，会添加重复规则。</span>
             </div>
        </form>
    </div>
</div>


{# 规则列表 #}
<h2 class="mb-3">当前 NAT PREROUTING 规则 (来自 iptables)</h2>

<form action="{{ url_for('clear_all_prerouting') }}" method="post" onsubmit="return confirm('您确定要清空 NAT PREROUTING 链的所有规则吗？此操作不可逆！');" class="mb-3">
    {{ dnat_form.csrf_token }} {# CSRF for this form #}
    <button type="submit" class="btn btn-danger">清空所有 PREROUTING 规则</button>
    <p class="text-muted mt-2">警告：这将强制删除 iptables NAT 表 PREROUTING 链的所有规则，包括非本应用添加的！</p>
</form>


{% if rules %}
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover caption-top">
         <caption>当前的 PREROUTING 转发规则 (仅显示 DNAT)</caption>
        <thead class="table-light">
            <tr>
                <th>行号</th>
                <th>协议</th>
                <th>入站接口</th>
                <th>目标端口</th>
                <th> -> </th>
                <th>目标地址:端口</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in rules %}
            <tr>
                <td>{{ rule.line_number }}</td>
                <td>{{ rule.protocol }}</td>
                <td>{{ rule.in_interface }}</td>
                <td>{{ rule.dport }}</td>
                <td>→</td>
                <td>{{ rule.to_destination }}</td>
                <td>
                    <form action="{{ url_for('index') }}" method="post" style="display:inline;">
                        {{ dnat_form.csrf_token }} {# CSRF for this delete form #}
                        <input type="hidden" name="line_number" value="{{ rule.line_number }}">
                        <button type="submit" class="btn btn-danger btn-sm" name="delete_rule_submit" onclick="return confirm('您确定要删除行号为 {{ rule.line_number }} 的规则吗？\n注意：行号可能会变化，请谨慎操作！');">删除</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="text-muted">注意：此列表尝试解析并显示 NAT 表 PREROUTING 链中符合简单 DNAT 格式的规则。删除操作基于当前的行号，如果在操作期间其他规则有变动，行号可能不再准确。</p>
{% else %}
<div class="alert alert-info" role="alert">
    NAT PREROUTING 链当前没有符合格式的转发规则。请添加一条规则。
</div>
{% endif %}


{% endblock %}
