{% extends 'layout.html' %}

{% block content %}

<p class="alert alert-info">
    管理当前系统的 iptables NAT PREROUTING 规则。规则**不持久化**，重启丢失。需要足够权限运行此应用。
    公网网卡: <strong>{{ public_interface }}</strong> (IP: <strong>{{ interface_ip }}</strong>)。
</p>

<div class="card mb-4">
    <div class="card-header">
        添加端口转发规则 (DNAT)
    </div>
    <div class="card-body">
        <form method="POST" class="row g-3 align-items-end">
            {{ dnat_form.csrf_token }}
            {{ dnat_form.form_id }}

            <div class="col-md-auto">
                {{ dnat_form.protocol.label(class_="form-label") }}
                {{ dnat_form.protocol(class_="form-select", **{'is-invalid': dnat_form.protocol.errors}) }}
                {% for error in dnat_form.protocol.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.public_port.label(class_="form-label") }}
                {{ dnat_form.public_port(class_="form-control", type="number", min="1", max="65535", placeholder="主机端口", **{'is-invalid': dnat_form.public_port.errors}) }}
                {% for error in dnat_form.public_port.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto d-flex align-items-center mb-3">
                 <span class="fw-bold fs-5 text-muted">({{ interface_ip or public_interface }}:PORT) → 内网</span>
            </div>

            <div class="col-md-auto">
                {{ dnat_form.internal_ip.label(class_="form-label") }}
                {{ dnat_form.internal_ip(class_="form-control", placeholder="内网 IP", **{'is-invalid': dnat_form.internal_ip.errors}) }}
                 {% for error in dnat_form.internal_ip.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.container_port.label(class_="form-label") }}
                {{ dnat_form.container_port(class_="form-control", type="number", min="1", max="65535", placeholder="容器端口", **{'is-invalid': dnat_form.container_port.errors}) }}
                 {% for error in dnat_form.container_port.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="col-md-auto">
                {{ dnat_form.submit(class_="btn btn-primary") }}
            </div>
        </form>
         {% if dnat_form.errors %}
             <div class="alert alert-warning mt-3">请检查输入错误。</div>
         {% endif %}
    </div>
</div>

<h2 class="mb-3">当前 NAT PREROUTING 规则</h2>

<form action="{{ url_for('clear_all_prerouting') }}" method="post" onsubmit="return confirm('确定清空 NAT PREROUTING 链所有规则？不可逆！');" class="mb-3">
    {{ dnat_form.csrf_token }}
    <button type="submit" class="btn btn-danger">清空所有规则</button>
    <p class="text-muted mt-2">警告：将强制删除此链所有规则！</p>
</form>

{% if rules %}
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover caption-top">
         <caption>当前的 PREROUTING 转发规则</caption>
        <thead class="table-light">
            <tr>
                <th>行号</th>
                <th>target</th>
                <th>prot</th>
                <th>in</th>
                <th>out</th>
                <th>source</th>
                <th>destination</th>
                <th>扩展信息 / DNAT目标</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in rules %}
            <tr>
                <td>{{ rule.line_number }}</td>
                <td>{{ rule.target }}</td>
                <td>{{ rule.protocol }}</td>
                <td>{{ rule.in_interface }}</td>
                <td>{{ rule.out_interface }}</td>
                <td>{{ rule.source }}</td>
                <td>{{ rule.destination }}</td>
                <td>
                    {% if rule.target == 'DNAT' and rule.to_destination %}
                         <span class="badge bg-info me-1">DNAT</span> {{ rule.to_destination }}
                         {% if rule.extra_info %}
                             <small class="text-muted"> ({{ rule.extra_info }})</small>
                         {% endif %}
                    {% else %}
                        {{ rule.extra_info or '-' }}
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('index') }}" method="post" style="display:inline;">
                        {{ dnat_form.csrf_token }}
                        <input type="hidden" name="line_number" value="{{ rule.line_number }}">
                        <button type="submit" class="btn btn-danger btn-sm" name="delete_rule_submit" onclick="return confirm('确定删除行号 {{ rule.line_number }} 的规则？\n注意：行号可能变化！请刷新页面。');">删除</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p class="text-muted">列表显示 PREROUTING 链所有规则。删除基于当前行号，操作后请刷新页面。</p>
{% else %}
<div class="alert alert-info" role="alert">
    NAT PREROUTING 链当前没有规则或无法解析。请添加规则。
</div>
{% endif %}

{% endblock %}
