<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVE LXC NAT Manager</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions a, .actions button { margin-right: 5px; }
        .status { font-weight: bold; }
        .status.enabled { color: green; }
        .status.disabled { color: red; }
        .flash-messages { margin-bottom: 15px; padding: 10px; border-radius: 5px; }
        .flash-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .flash-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <h1>PVE LXC NAT Manager</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <p>
        <a href="{{ url_for('add_rule') }}"><button>Add New Rule</button></a>
        <form method="POST" action="{{ url_for('apply_all') }}" style="display: inline;">
             <button type="submit">Apply All Enabled Rules to Firewall</button>
        </form>
    </p>

    <h2>NAT Rules</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Description</th>
                <th>LXC ID</th>
                <th>Ext IP</th>
                <th>Ext Port</th>
                <th>Proto</th>
                <th>Container Port</th>
                 <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in rules %}
            <tr>
                <td>{{ rule.id }}</td>
                <td>{{ rule.description }}</td>
                <td>{{ rule.lxc_id }}</td>
                <td>{{ rule.external_ip }}</td>
                <td>{{ rule.external_port }}</td>
                <td>{{ rule.protocol | upper }}</td>
                <td>{{ rule.container_port }}</td>
                <td>
                    <span class="status {% if rule.enabled %}enabled{% else %}disabled{% endif %}">
                        {{ "Enabled" if rule.enabled else "Disabled" }}
                    </span>
                </td>
                <td class="actions">
                     <form method="POST" action="{{ url_for('toggle_rule', rule_id=rule.id) }}" style="display: inline;">
                        <button type="submit">{{ "Disable" if rule.enabled else "Enable" }}</button>
                    </form>
                    <a href="{{ url_for('edit_rule', rule_id=rule.id) }}"><button>Edit</button></a>
                    <form method="POST" action="{{ url_for('delete_rule', rule_id=rule.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete rule ID {{ rule.id }}?');">
                        <button type="submit">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9">No NAT rules configured yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p style="margin-top: 20px; font-size: 0.9em; color: #555;">
        Note: Applying rules requires root privileges on the PVE host. Ensure the application is run with appropriate permissions (e.g., via sudo with NOPASSWD configured for the necessary commands).
        Rules are applied to the custom iptables chain <code>PVE_LXC_NAT</code>.
    </p>

</body>
</html>
